apiVersion: v1
kind: Namespace
metadata:
  name: bankus
---
apiVersion: v1
kind: Secret
metadata:
  name: bankus-secrets
  namespace: bankus
type: Opaque
stringData:
  MONGO_ROOT_USER: "bankus_user"
  MONGO_ROOT_PASS: "bankus_secret_pass"
  JWT_SECRET: "changeme"
  CAPTCHA_SECRET: "6LcbqzYsAAAAAK-R9YeEAReNG8Ruc8CX4F9HJfh3"
  RAPIDAPI_KEY: "67003e5001msha772ef722235103p1373e7jsn12b8883ecce9"
  SENDGRID_API_KEY: "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"
---
# --- REDIS CACHE ---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis-cache
  namespace: bankus
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis-cache
  template:
    metadata:
      labels:
        app: redis-cache
    spec:
      containers:
        - name: redis
          image: redis:alpine
          imagePullPolicy: Always
          ports:
            - containerPort: 6379
          livenessProbe:
            exec:
              command: ["redis-cli", "ping"]
            initialDelaySeconds: 30
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 5
---
apiVersion: v1
kind: Service
metadata:
  name: redis-cache
  namespace: bankus
spec:
  selector:
    app: redis-cache
  ports:
    - port: 6379
      targetPort: 6379

---
# --- MONGO PRINCIPAL ---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mongo-pvc
  namespace: bankus
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mongo
  namespace: bankus
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mongo
  template:
    metadata:
      labels:
        app: mongo
    spec:
      containers:
        - name: mongo
          image: mongo:7
          ports:
            - containerPort: 27017
          env:
            - name: MONGO_INITDB_ROOT_USERNAME
              valueFrom:
                secretKeyRef:
                  name: bankus-secrets
                  key: MONGO_ROOT_USER
            - name: MONGO_INITDB_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: bankus-secrets
                  key: MONGO_ROOT_PASS
          volumeMounts:
            - name: mongo-data
              mountPath: /data/db
          livenessProbe:
            exec:
              command:
                - bash
                - -c
                - "mongosh --quiet -u $MONGO_INITDB_ROOT_USERNAME -p $MONGO_INITDB_ROOT_PASSWORD --authenticationDatabase admin --eval \"db.adminCommand('ping')\""
            initialDelaySeconds: 40
            periodSeconds: 15
            timeoutSeconds: 30
            failureThreshold: 5
      volumes:
        - name: mongo-data
          persistentVolumeClaim:
            claimName: mongo-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: mongo
  namespace: bankus
spec:
  selector:
    app: mongo
  ports:
    - port: 27017
      targetPort: 27017
---
# --- MICROSERVICE ACCOUNTS ---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: microservice-accounts
  namespace: bankus
spec:
  replicas: 1
  selector:
    matchLabels:
      app: microservice-accounts
  template:
    metadata:
      labels:
        app: microservice-accounts
    spec:
      containers:
        - name: accounts
          image: alvvigsua/microservice-accounts:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 8000
          env:
            - name: MONGO_CONNECTION_STRING
              # Actualizado segÃºn docker-compose (cluster0.xjcvtil)
              value: "mongodb+srv://alvvigsua_db_user:g4tPaQcYxCwkZ12j@cluster0.xjcvtil.mongodb.net/?appName=Cluster0"
            - name: MONGO_DATABASE_NAME
              value: "accounts"
            - name: REDIS_HOST
              value: "redis-cache"
            - name: REDIS_PORT
              value: "6379"
            - name: CURRENCIES_MICROSERVICE_BASE_URL
              value: "http://microservice-currencies:8000"
            - name: CARD_MICROSERVICE_BASE_URL
              value: "http://microservice-cards:3000"
            - name: AUTH_MICROSERVICE_BASE_URL
              value: "http://microservice-user-auth:3000"
            - name: AUTH_MICROSERVICE_CREATE_USER_ENDPOINT
              value: "/v1/users"
          livenessProbe:
            exec:
              command: ["curl", "-f", "http://localhost:8000/v1/health"]
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 5
---
apiVersion: v1
kind: Service
metadata:
  name: microservice-accounts
  namespace: bankus
spec:
  selector:
    app: microservice-accounts
  ports:
    - port: 8000
      targetPort: 8000

---
# --- MICROSERVICE CURRENCIES ---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: microservice-currencies
  namespace: bankus
spec:
  replicas: 1
  selector:
    matchLabels:
      app: microservice-currencies
  template:
    metadata:
      labels:
        app: microservice-currencies
    spec:
      containers:
        - name: currencies
          image: alvvigsua/microservice-currencies:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 8000
          env:
            - name: EXTERNAL_API_KEY
              valueFrom:
                secretKeyRef:
                  name: bankus-secrets
                  key: RAPIDAPI_KEY
            - name: EXTERNAL_API_URL
              value: "https://currency-converter-pro1.p.rapidapi.com/latest-rates"
            - name: EXTERNAL_API_HOST
              value: "currency-converter-pro1.p.rapidapi.com"
            - name: REDIS_HOST
              value: "redis-cache"
            - name: REDIS_PORT
              value: "6379"
          livenessProbe:
            exec:
              command: ["wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8000/actuator/health"]
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 5
---
apiVersion: v1
kind: Service
metadata:
  name: microservice-currencies
  namespace: bankus
spec:
  selector:
    app: microservice-currencies
  ports:
    - port: 8000
      targetPort: 8000

---
# --- MICROSERVICE CARDS ---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: microservice-cards
  namespace: bankus
spec:
  replicas: 1
  selector:
    matchLabels:
      app: microservice-cards
  template:
    metadata:
      labels:
        app: microservice-cards
    spec:
      containers:
        - name: cards
          image: pabmedmej/microservice-cards:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 3000
          env:
            - name: MONGODB_URI
              value: "mongodb+srv://srmedinillx_db_user:arartQ2R1LM5pUAD@cluster0.cwmpopc.mongodb.net/?appName=Cluster0"
            - name: MONGODB_DB
              value: "cards_db"
            - name: REDIS_URL
              value: "redis://redis-cache:6379"
---
apiVersion: v1
kind: Service
metadata:
  name: microservice-cards
  namespace: bankus
spec:
  selector:
    app: microservice-cards
  ports:
    - port: 3000
      targetPort: 3000

---
# --- MICROSERVICE TRANSFERS ---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: microservice-transfers
  namespace: bankus
spec:
  replicas: 1
  selector:
    matchLabels:
      app: microservice-transfers
  template:
    metadata:
      labels:
        app: microservice-transfers
    spec:
      containers:
        - name: transfers
          image: jearpo/microservice-transfers:latest
          imagePullPolicy: Always
          command: ["uvicorn", "src.transfers.app:create_app", "--factory", "--host", "0.0.0.0", "--port", "8000"]
          ports:
            - containerPort: 8000
          env:
            - name: MONGO_CONNECTION_STRING
              value: "mongodb://bankus_user:bankus_secret_pass@mongo:27017"
            - name: MONGO_DATABASE_NAME
              value: "transactions_db"
            - name: ACCOUNTS_SERVICE_URL
              value: "http://microservice-accounts:8000"
            - name: TRANSFERS_SERVICE_URL
              value: "http://microservice-transfers:8000"
            - name: FRAUD_SERVICE
              value: "http://microservice-anti-fraud:8000"
            - name: AUTH_SERVICE
              value: "http://microservice-user-auth:3000"
            - name: REDIS_HOST
              value: "redis-cache"
            - name: REDIS_PORT
              value: "6379"
          livenessProbe:
            exec:
              command: ["curl", "-f", "http://localhost:8000/health"]
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 11
            failureThreshold: 5
---
apiVersion: v1
kind: Service
metadata:
  name: microservice-transfers
  namespace: bankus
spec:
  selector:
    app: microservice-transfers
  ports:
    - port: 8000
      targetPort: 8000
---
# --- MICROSERVICE USER AUTH ---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: microservice-user-auth
  namespace: bankus
spec:
  replicas: 1
  selector:
    matchLabels:
      app: microservice-user-auth
  template:
    metadata:
      labels:
        app: microservice-user-auth
    spec:
      containers:
        - name: user-auth
          image: rubjimjim/microservice-userauth:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 3000
          env:
            - name: PORT
              value: "3000"
            - name: MONGO_URI
              value: "mongodb://bankus_user:bankus_secret_pass@mongo:27017/userauth_db?authSource=admin"
            - name: MONGO_HOST
              value: "mongo"
            - name: MONGO_PORT
              value: "27017"
            - name: MONGO_DB
              value: "userauth_db"
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: bankus-secrets
                  key: JWT_SECRET
          livenessProbe:
            exec:
              command: ["node", "-e", "fetch('http://localhost:3000/v1/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"]
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 5
---
apiVersion: v1
kind: Service
metadata:
  name: microservice-user-auth
  namespace: bankus
spec:
  selector:
    app: microservice-user-auth
  ports:
    - port: 3000
      targetPort: 3000

# --- MICROSERVICE SCHEDULED PAYMENTS ---
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: microservice-scheduled-payments
  namespace: bankus
spec:
  replicas: 1
  selector:
    matchLabels:
      app: microservice-scheduled-payments
  template:
    metadata:
      labels:
        app: microservice-scheduled-payments
    spec:
      containers:
        - name: scheduler
          image: joscosguius/microservice-scheduler
          imagePullPolicy: Always
          ports:
            - containerPort: 8000
          env:
            - name: MONGO_CONNECTION_STRING
              value: "mongodb://mongodb-scheduler:27017"
            - name: MONGO_DATABASE_NAME
              value: "scheduled_payments"
            - name: TRANSFER_SERVICE_URL
              value: "http://microservice-transfers:8000/v1/transactions"
            - name: ACCOUNTS_SERVICE_URL
              # Corregido: 'accounts-service' no existe, es 'microservice-accounts'
              value: "http://microservice-accounts:8000/v1/accounts/{iban}"
            - name: SUBSCRIPTION_BASIC
              value: "1"
            - name: SUBSCRIPTION_STUDENT
              value: "10"
            - name: SUBSCRIPTION_PRO
              value: "-1"
            - name: SCHEDULER_INTERVAL_SECONDS
              value: "60"
            - name: HEALTHCHECK_URL
              value: "http://localhost:8000/v1/scheduled-payments/health"
            - name: NTP_SERVER
              value: "pool.ntp.org"
            - name: NTP_REFRESH_SECONDS
              value: "60"
            - name: NTP_TIMEOUT_SECONDS
              value: "3"
          livenessProbe:
            exec:
              command: ["curl", "-f", "http://localhost:8000/v1/scheduled-payments/health"]
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 5
---
apiVersion: v1
kind: Service
metadata:
  name: microservice-scheduled-payments
  namespace: bankus
spec:
  selector:
    app: microservice-scheduled-payments
  ports:
    - port: 8000
      targetPort: 8000
---
# --- MICROSERVICE BANK STATEMENTS ---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: microservice-bank-statements
  namespace: bankus
spec:
  replicas: 1
  selector:
    matchLabels:
      app: microservice-bank-statements
  template:
    metadata:
      labels:
        app: microservice-bank-statements
    spec:
      containers:
        - name: bank-statements
          image: edithct/microservice-bank-statements:1.0.0
          imagePullPolicy: Always
          ports:
            - containerPort: 3000
          env:
            - name: PORT
              value: "3000"
            - name: MONGO_URI
              value: "mongodb://bankus_user:bankus_secret_pass@mongo:27017/bankstatements?authSource=admin"
            - name: NODE_ENV
              value: production
            - name: MS_STRATEGY
              value: "http"
            - name: STRATEGIES_HTTP_ACCOUNTS_BASE
              value: "http://microservice-accounts:8000"
            - name: STRATEGIES_HTTP_TRANSACTIONS_BASE
              value: "http://microservice-transfers:8000"
            - name: STRATEGIES_HTTP_NOTIFICATIONS_BASE
              value: "http://microservice-notifications:8000"
          livenessProbe:
            exec:
              command: ["node", "-e", "fetch('http://localhost:3000/').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"]
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 11
            failureThreshold: 5
---
apiVersion: v1
kind: Service
metadata:
  name: microservice-bank-statements
  namespace: bankus
spec:
  selector:
    app: microservice-bank-statements
  ports:
    - port: 3000
      targetPort: 3000

# --- MICROSERVICE NOTIFICATIONS ---
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: microservice-notifications
  namespace: bankus
spec:
  replicas: 1
  selector:
    matchLabels:
      app: microservice-notifications
  template:
    metadata:
      labels:
        app: microservice-notifications
    spec:
      containers:
        - name: notifications
          image: elenaberdugo/microservice-notifications:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 8000
          env:
            - name: MONGO_CONNECTION_STRING
              value: "mongodb://mongodb-notifications:27017"
            - name: MONGO_DATABASE_NAME
              value: "notifications_db"
            - name: SENDGRID_FROM_EMAIL
              value: "elenaberdu@gmail.com"
            - name: SENDGRID_API_KEY
              valueFrom:
                secretKeyRef:
                  name: bankus-secrets
                  key: SENDGRID_API_KEY
          livenessProbe:
            exec:
              command: ["curl", "-f", "http://localhost:8000/v1/notifications/health"]
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 5
---
apiVersion: v1
kind: Service
metadata:
  name: microservice-notifications
  namespace: bankus
spec:
  selector:
    app: microservice-notifications
  ports:
    - port: 8000
      targetPort: 8000

# --- MICROSERVICE ANTI FRAUD ---
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: microservice-anti-fraud
  namespace: bankus
spec:
  replicas: 1
  selector:
    matchLabels:
      app: microservice-anti-fraud
  template:
    metadata:
      labels:
        app: microservice-anti-fraud
    spec:
      containers:
        - name: antifraud
          image: angelmr01/microservice-antifraud:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 8000
          env:
            - name: PORT
              value: "8000"
            - name: MONGO_URI
              value: "mongodb://bankus_user:bankus_secret_pass@mongo:27017/antifraud_db?authSource=admin"
            - name: MONGO_DB
              value: "antifraud_db"
            - name: REDIS_HOST
              value: "redis-cache"
            - name: REDIS_PORT
              value: "6379"
            - name: REDIS_URL
              value: "redis://redis-cache:6379"
            - name: ACCOUNTS_MS_URL
              value: "http://microservice-accounts:8000"
            - name: TRANSFERS_MS_URL
              value: "http://microservice-transfers:8000"
            - name: NOTIFICATIONS_MS_URL
              value: "http://microservice-notifications:8000"
            - name: ACCOUNTS_BLOCK_TIMEOUT_MS
              value: "3000"
          livenessProbe:
            exec:
              command: ["node", "-e", "fetch('http://localhost:8000/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"]
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 5
---
apiVersion: v1
kind: Service
metadata:
  name: microservice-anti-fraud
  namespace: bankus
spec:
  selector:
    app: microservice-anti-fraud
  ports:
    - port: 8000
      targetPort: 8000

# --- API GATEWAY ---
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-gateway
  namespace: bankus
spec:
  replicas: 1
  selector:
    matchLabels:
      app: api-gateway
  template:
    metadata:
      labels:
        app: api-gateway
    spec:
      containers:
        - name: nginx
          image: nginx:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 80
            - containerPort: 443
          volumeMounts:
            - name: config
              mountPath: /etc/nginx/nginx.conf
              subPath: nginx.conf
            - name: certs
              mountPath: /etc/nginx/certs
              readOnly: true
          livenessProbe:
            tcpSocket:
              port: 80
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 5
      volumes:
        - name: config
          configMap:
            name: nginx-config
        - name: certs
          secret:
            secretName: nginx-certs
            optional: true
        
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mongodb-scheduler
  namespace: bankus
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mongodb-scheduler
  template:
    metadata:
      labels:
        app: mongodb-scheduler
    spec:
      containers:
        - name: mongo
          image: mongo:7
          ports:
            - containerPort: 27017
---
apiVersion: v1
kind: Service
metadata:
  name: mongodb-scheduler
  namespace: bankus
spec:
  selector:
    app: mongodb-scheduler
  ports:
    - port: 27017
      targetPort: 27017
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mongodb-notifications
  namespace: bankus
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mongodb-notifications
  template:
    metadata:
      labels:
        app: mongodb-notifications
    spec:
      containers:
        - name: mongo
          image: mongo:7
          ports:
            - containerPort: 27017
---
apiVersion: v1
kind: Service
metadata:
  name: mongodb-notifications
  namespace: bankus
spec:
  selector:
    app: mongodb-notifications
  ports:
    - port: 27017
      targetPort: 27017

---
apiVersion: v1
kind: Service
metadata:
  name: api-gateway
  namespace: bankus
spec:
  type: LoadBalancer 
  selector:
    app: api-gateway
  ports:
    - name: http
      port: 10000        # Puerto expuesto al exterior
      targetPort: 80