services:
  # --- REDIS CACHE ---
  redis-cache:
    image: redis:alpine
    container_name: redis-cache
    restart: always
    ports:
      - "6379:6379"
    networks:
      - bankus-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # --- MONGO PRINCIPAL ---
  mongo:
    image: mongo:7
    container_name: mongo
    restart: always
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: bankus_user
      MONGO_INITDB_ROOT_PASSWORD: bankus_secret_pass
    volumes:
      - mongo-data:/data/db
    networks:
      - bankus-network
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "-u", "bankus_user", "-p", "bankus_secret_pass", "--authenticationDatabase", "admin", "--eval", "db.adminCommand('ping')"]
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 40s

  # --- MICROSERVICE ACCOUNTS ---
  microservice-accounts:
    image: alvvigsua/microservice-accounts:latest
    container_name: microservice-accounts
    restart: always
    ports:
      - "8001:8000" # Mapeado al 8001 en host para evitar conflictos si pruebas local
    environment:
      MONGO_CONNECTION_STRING: "mongodb+srv://alvvigsua_db_user:g4tPaQcYxCwkZ12j@cluster0.xjcvtil.mongodb.net/?appName=Cluster0"
      MONGO_DATABASE_NAME: "accounts"
      REDIS_HOST: "redis-cache"
      REDIS_PORT: "6379"
      CURRENCIES_MICROSERVICE_BASE_URL: "http://microservice-currencies:8000"
      CARD_MICROSERVICE_BASE_URL: "http://microservice-cards:3000"
      AUTH_MICROSERVICE_BASE_URL: "http://microservice-user-auth:3000"
      AUTH_MICROSERVICE_CREATE_USER_ENDPOINT: "/v1/users"
    networks:
      - bankus-network
    depends_on:
      redis-cache:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  # --- MICROSERVICE CURRENCIES ---
  microservice-currencies:
    image: alvvigsua/microservice-currencies:latest
    container_name: microservice-currencies
    restart: always
    ports:
      - "8002:8000"
    environment:
      EXTERNAL_API_KEY: "67003e5001msha772ef722235103p1373e7jsn12b8883ecce9"
      EXTERNAL_API_URL: "https://currency-converter-pro1.p.rapidapi.com/latest-rates"
      EXTERNAL_API_HOST: "currency-converter-pro1.p.rapidapi.com"
      REDIS_HOST: "redis-cache"
      REDIS_PORT: "6379"
    networks:
      - bankus-network
    depends_on:
      redis-cache:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8000/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  # --- MICROSERVICE CARDS ---
  microservice-cards:
    image: pabmedmej/microservice-cards:latest
    container_name: microservice-cards
    restart: always
    ports:
      - "3000:3000"
    environment:
      MONGODB_URI: "mongodb+srv://srmedinillx_db_user:arartQ2R1LM5pUAD@cluster0.cwmpopc.mongodb.net/?appName=Cluster0"
      MONGODB_DB: "cards_db"
      REDIS_URL: "redis://redis-cache:6379"
    networks:
      - bankus-network

  # --- MICROSERVICE TRANSFERS ---
  microservice-transfers:
    image: jearpo/microservice-transfers:latest
    container_name: microservice-transfers
    restart: always
    command: ["uvicorn", "src.transfers.app:create_app", "--factory", "--host", "0.0.0.0", "--port", "8000"]
    ports:
      - "8003:8000"
    environment:
      MONGO_CONNECTION_STRING: "mongodb://bankus_user:bankus_secret_pass@mongo:27017"
      MONGO_DATABASE_NAME: "transactions_db"
      ACCOUNTS_SERVICE_URL: "http://microservice-accounts:8000"
      TRANSFERS_SERVICE_URL: "http://microservice-transfers:8000"
      FRAUD_SERVICE: "http://microservice-anti-fraud:8000"
      AUTH_SERVICE: "http://microservice-user-auth:3000"
      REDIS_HOST: "redis-cache"
      REDIS_PORT: "6379"
    networks:
      - bankus-network
    depends_on:
      mongo:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 11s
      retries: 5

  # --- MICROSERVICE USER AUTH ---
  microservice-user-auth:
    image: rubjimjim/microservice-userauth:latest
    container_name: microservice-user-auth
    restart: always
    ports:
      - "3001:3000"
    environment:
      PORT: "3000"
      MONGO_URI: "mongodb://bankus_user:bankus_secret_pass@mongo:27017/userauth_db?authSource=admin"
      MONGO_HOST: "mongo"
      MONGO_PORT: "27017"
      MONGO_DB: "userauth_db"
      JWT_SECRET: "changeme"
    networks:
      - bankus-network
    depends_on:
      mongo:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3000/v1/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 5

  # --- MICROSERVICE SCHEDULED PAYMENTS ---
  microservice-scheduled-payments:
    image: joscosguius/microservice-scheduler
    container_name: microservice-scheduled-payments
    restart: always
    ports:
      - "8004:8000"
    environment:
      MONGO_CONNECTION_STRING: "mongodb://mongodb-scheduler:27017"
      MONGO_DATABASE_NAME: "scheduled_payments"
      TRANSFER_SERVICE_URL: "http://microservice-transfers:8000/v1/transactions"
      ACCOUNTS_SERVICE_URL: "http://microservice-accounts:8000/v1/accounts/{iban}"
      SUBSCRIPTION_BASIC: 1
      SUBSCRIPTION_STUDENT: 10
      SUBSCRIPTION_PRO: -1 # -1 = ilimitado
      SCHEDULER_INTERVAL_SECONDS: "60"
      HEALTHCHECK_URL: "http://localhost:8000/v1/scheduled-payments/health"
      NTP_SERVER: pool.ntp.org
      NTP_REFRESH_SECONDS: 60
      NTP_TIMEOUT_SECONDS: 3
    networks:
      - bankus-network
    depends_on:
      mongodb-scheduler:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/v1/scheduled-payments/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  # --- MICROSERVICE BANK STATEMENTS ---
  microservice-bank-statements:
    image: edithct/microservice-bank-statements:1.0.0
    container_name: microservice-bank-statements
    restart: always
    ports:
      - "3002:3000"
    environment:
      PORT: "3000"
      MONGO_URI: "mongodb://bankus_user:bankus_secret_pass@mongo:27017/bankstatements?authSource=admin"
      NODE_ENV: "production"
      MS_STRATEGY: "http"
      STRATEGIES_HTTP_ACCOUNTS_BASE: "http://microservice-accounts:8000"
      STRATEGIES_HTTP_TRANSACTIONS_BASE: "http://microservice-transfers:8000"
      STRATEGIES_HTTP_NOTIFICATIONS_BASE: "http://microservice-notifications:8000"
    networks:
      - bankus-network
    depends_on:
      mongo:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3000/').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"]
      interval: 30s
      timeout: 11s
      retries: 5

  # --- MICROSERVICE NOTIFICATIONS ---
  microservice-notifications:
    image: elenaberdugo/microservice-notifications:latest
    container_name: microservice-notifications
    restart: always
    ports:
      - "8005:8000"
    environment:
      MONGO_CONNECTION_STRING: "mongodb://mongodb-notifications:27017"
      MONGO_DATABASE_NAME: "notifications_db"
      SENDGRID_FROM_EMAIL: "elenaberdu@gmail.com"
      SENDGRID_API_KEY: "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"
    networks:
      - bankus-network
    depends_on:
      mongodb-notifications:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/v1/notifications/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  # --- MICROSERVICE ANTI FRAUD ---
  microservice-anti-fraud:
    image: angelmr01/microservice-antifraud:latest
    container_name: microservice-anti-fraud
    restart: always
    ports:
      - "8006:8000"
    environment:
      PORT: "8000"
      MONGO_URI: "mongodb://bankus_user:bankus_secret_pass@mongo:27017/antifraud_db?authSource=admin"
      MONGO_DB: "antifraud_db"
      REDIS_HOST: "redis-cache"
      REDIS_PORT: "6379"
      REDIS_URL: "redis://redis-cache:6379"
      ACCOUNTS_MS_URL: "http://microservice-accounts:8000"
      TRANSFERS_MS_URL: "http://microservice-transfers:8000"
      NOTIFICATIONS_MS_URL: "http://microservice-notifications:8000"
      ACCOUNTS_BLOCK_TIMEOUT_MS: "3000"
    networks:
      - bankus-network
    depends_on:
      mongo:
        condition: service_healthy
      redis-cache:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:8000/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 5

  # --- MONGODB SCHEDULER (Instancia separada) ---
  mongodb-scheduler:
    image: mongo:7
    container_name: mongodb-scheduler
    restart: always
    ports:
      - "27018:27017"
    networks:
      - bankus-network
    volumes:
      - mongo-scheduler-data:/data/db

  # --- MONGODB NOTIFICATIONS (Instancia separada) ---
  mongodb-notifications:
    image: mongo:7
    container_name: mongodb-notifications
    restart: always
    ports:
      - "27019:27017"
    networks:
      - bankus-network
    volumes:
      - mongo-notifications-data:/data/db

  # --- API GATEWAY (NGINX) ---
  api-gateway:
    image: nginx:latest
    container_name: api-gateway
    restart: always
    ports:
      - "10000:80" # Puerto expuesto definido en el Service LoadBalancer
      # - "443:443"
    networks:
      - bankus-network
    # IMPORTANTE: Debes crear un archivo nginx.conf localmente con la configuración
    # de tu API Gateway y descomentar la siguiente línea:
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./certs:/etc/nginx/certs # Si tienes certificados
    depends_on:
      - microservice-accounts
      - microservice-transfers

volumes:
  mongo-data:
  mongo-scheduler-data:
  mongo-notifications-data:

networks:
  bankus-network:
    driver: bridge
    name: bankus-net